/**
 * @type {JSFoundset}
 *
 * @properties={typeid:35,uuid:"A08C509E-C0BA-41A0-BF88-BDB39C7ABC86",variableType:-4}
 */
var fs;

/**
 * @properties={typeid:35,uuid:"83ED2B5A-61EE-43B3-9247-89B15B56D883",variableType:-4}
 */
var _idDitta = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"81258F93-B0AB-405D-9C67-730CB1F3F1A2",variableType:8}
 */
var _codiceDitta = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"F2DA2CCD-F8C2-4C66-B939-5DE1C115C19F"}
 */
var _ragioneSocialeDitta = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"0AFF50B2-8FF0-4618-A276-BD9D32B3D793",variableType:8}
 */
var _idDittaLegata = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"1CF64C98-28BD-463C-8960-8820939B9D4B",variableType:8}
 */
var _codiceDip = null;

/**
 * @properties={typeid:35,uuid:"E5AA50FF-1858-4CEE-9101-F213A85ABAE3",variableType:-4}
 */
var _idDittaSede = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"DD9505AC-84F8-43EE-AA7E-55EE35762EAD",variableType:8}
 */
var _codiceDittaSede = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"91FFB6A0-6F35-4B3B-B237-B40B4E169FF3"}
 */
var _descDittaSede = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"8F6B37B6-DBBC-468C-9844-E39596C3AABA",variableType:8}
 */
var _codiceInpsDip = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"C234A55E-73A8-4A91-88A0-D5E46B4FD727"}
 */
var _descInpsDip = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"3AC70D1F-B6FF-494C-8363-B56B09E84D5E",variableType:8}
 */
var _idInpsDitta = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"88432826-C90A-41A8-A27E-9A4307A5F436",variableType:8}
 */
var _idDittaInailPosizione = null;

/**
 * @properties={typeid:35,uuid:"3FB6A64B-C824-42DF-B8B1-7AC77F1C295E",variableType:-4}
 */
var _idGrContr = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"CA2570DC-550B-4FF3-84BA-BDB53EFC5219",variableType:8}
 */
var _codGrContr = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"985591A2-7509-4456-8AFA-20FB80F6A23C"}
 */
var _descGrContr = null;

/**
 * @properties={typeid:35,uuid:"8935FD6F-4B0C-444A-92D7-EE9054803D51",variableType:-4}
 */
var _idQualifica = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"45667C0B-CE44-44CB-B839-A5663474A1FA"}
 */
var _codQualifica = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"749EAD3A-B6DE-4D17-91E2-C36775DC0CFC"}
 */
var _descQualifica = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"FE15A05E-E0DF-4431-8F6F-09BAEEE7F605",variableType:8}
 */
var _percPartTime = null;

/**
 * @type {Boolean}
 *
 * @properties={typeid:35,uuid:"DB06835D-9424-4FDD-B45E-9D1721988D13",variableType:-4}
 */
var _utilizzaMensa = false;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"FEEF6598-6AAF-48A3-93F0-7E0BB8F31DC0"}
 */
var _cognome = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"7D95EC54-484C-4637-96C5-94866C8BFF74"}
 */
var _nome = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"4CF0F83B-9109-4A98-8588-240879FE6D33"}
 */
var _codiceFiscale = null;

/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"B3459757-031E-4B84-8016-C9236C3C4A13",variableType:93}
 */
var _dataAssunzione = null;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"E0CC6CE2-DA41-4FC1-9AE7-C0C04625AA85",variableType:4}
 */
var _chkImportaDaFile = 0;

/**
 * @type {Number}
 *
 * @properties={typeid:35,uuid:"407374AB-7C2A-4B58-ACCC-4DB47A5E69EB",variableType:4}
 */
var _chkInserisciManuale = 1;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"F0B689C5-04F3-46F4-B4E5-E2B2011192D4"}
 */
var _badge = null;

/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"93EE53A3-B37E-49C3-A4D2-AC306A03FA7C",variableType:93}
 */
var _badgeDal = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"DB5D69DA-AACF-4F72-A030-AD5DFCDCC57F"}
 */
var _idRegola = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"86F71B48-14EF-413B-92F4-FAFC5CF3BEF1"}
 */
var _codRegola = null;

/**
 * @properties={typeid:35,uuid:"4AD7929B-5ABA-4BCC-AD98-79B2652B1592",variableType:-4}
 */
var _codRiga = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"0C7CA2EC-332F-4375-A74A-892E93BD7DAB"}
 */
var _descRegola = null;

/**
 * @type {Date}
 * 
 * @properties={typeid:35,uuid:"401B8A0D-AD73-485D-BC3A-09FC3DB10EEF",variableType:93}
 */
var _regolaDal = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"CE12BB75-828F-441A-ABB4-2B2EE1102D47"}
 */
var _valoreAgg = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"97EFEC41-88E6-408D-9079-EBF782EE92B1"}
 */
var _descRiga = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"F0D463DE-9304-47E6-B96F-4A77A6AA7997",variableType:8}
 */
var _idInailPosizione = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"746340FE-8AF5-4D8A-80DC-C5580BAEE0CA"}
 */
var _codiceInailPosizione = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"D17A70E3-EC83-4E7C-8557-1E3E74792932"}
 */
var _descInailPosizione = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"A69DBDAC-DF0C-45CB-BB09-D3F94CCA9F9D"}
 */
var _tipoSesso = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"FAF48FA4-C43B-4C38-83AB-973FCC4B961C"}
 */
var _sesso = null;

/**
 * @type {Number}
 * 
 * @properties={typeid:35,uuid:"FB7D893F-AF3B-41D6-B089-5C7855C8CD4E",variableType:8}
 */
var _idLivello = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"B4225322-A63D-4DD3-8622-D6EABBC84169"}
 */
var _codLivello = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"17707C39-7345-461F-ABC1-0B86FC024F14"}
 */
var _tipoPaga = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"FB518F55-2BF5-4A11-B8EB-9C54252D23B7"}
 */
var _codTipoPaga = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"EA6573AA-FEE6-4927-96EF-BC21BDBF3D33"}
 */
var _tipoRapporto = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"30F9BAEE-3EF9-43EF-B5CB-679F11A25354"}
 */
var _codTipoRapporto = null;

/**
 * @properties={typeid:35,uuid:"D570738A-DD97-41BA-B872-1DDAB24DA098",variableType:-4}
 */
var _codTurnista = null;

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"6F8AFECB-EF3D-44E4-A4B1-BC72F3F94887"}
 */
var _email = '';

/**
 * @type {String}
 *
 * @properties={typeid:35,uuid:"9FF3C8E6-6B4D-4DDC-94BD-A0496A49F230"}
 */
var _cellulare = '';

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"E2916504-4B80-4113-8639-CAF9314294F9"}
 */
var _raggruppamento = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"0DE93BB7-4D0E-47C7-91D8-B62F7ADD589C"}
 */
var _codRaggruppamento = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"FF8CBB8F-B06C-468C-8E4F-EE9743ADCF20"}
 */
var _idDittaClassificazione = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"C4CD9403-DA58-4AE1-BCFD-66C2A2B949B7"}
 */
var _codRaggruppamentoDett = null;

/**
 * @type {String}
 * 
 * @properties={typeid:35,uuid:"387BEAE8-C240-48B5-B1C2-19EA3793C6E7"}
 */
var _descRaggruppamentoDett = null;

/**
 * @properties={typeid:24,uuid:"B8FCD71C-27F3-4A48-9168-F3578540CCAF"}
 */
function settaCodiceDipendente()
{
	// selezione automatica del codice dipendente con codice di valore numerico pari
	// al valore max correntemente presente pi√π uno
	var sqlMax = "SELECT MAX(Codice) FROM Lavoratori";
	var arrMax = [];
	var dsMax = databaseManager.getDataSetByQuery(globals.Server.MA_ANAGRAFICHE,sqlMax,arrMax,-1);
	var currMaxCod = dsMax.getValue(1,1);
	_codiceDip = currMaxCod + 1;
}

/**
 * @param {JSRecord} _rec
 *
 * @properties={typeid:24,uuid:"1F96E178-9102-41EC-9A23-DBB11C21F498"}
 */
function AggiornaSelezioneDitta(_rec)
{
	_idDitta = _rec['idditta'];
	_codiceDitta = _rec['codice'];
	_ragioneSocialeDitta = _rec['ragionesociale'];
	
    _idDittaSede = _codiceDittaSede = _descDittaSede = null;
	
	// aggiorna il codice dipendente al primo codice disponibile
	settaCodiceDipendente();
	
	// aggiorna le classificazioni disponibili
	AggiornaClassificazioni();	
	
	elements.fld_badge.visible = elements.fld_badge_dal.visible = (_idDitta != null && globals.haOrologio(_idDitta));
}

/**
 * @properties={typeid:24,uuid:"EADF54A6-69C1-4673-AEB8-FC7057E87049"}
 */
function AggiornaClassificazioni()
{
	// aggiorna le classificazioni disponibili
	var realValues = new Array();
	var displayValues = new Array();
	
	var ds = globals.getClassificazioniDitta(_idDitta);
	if(ds && ds.getMaxRowIndex())
	{
		for(var r = 1; r <= ds.getMaxRowIndex(); r++)
		{
			// iddittaclassificazione
			realValues.push(ds.getValue(r,1) + ' ' + ds.getValue(r,2));
			// codice + ' - ' + descrizione
			displayValues.push(ds.getValue(r,2) + ' - ' + ds.getValue(r,3));
		}
	}		
	application.setValueListItems('vls_raggruppamenti',displayValues,realValues);
	
//	elements.fld_raggruppamento.enabled =
//		elements.fld_codiceraggruppamento.enabled =
//			elements.fld_dettaglioraggruppamento.enabled =
//				elements.btn_raggruppamento.enabled =
//					 displayValues.length;
//	 application.updateUI();
}

/**
 * Filtra le posizioni INPS per il dipendente
 * 
 * @param {JSFoundset} fsInps
 *
 * @properties={typeid:24,uuid:"EA374607-6030-4344-BD60-C8CFB9920E70"}
 */
function filtraPosInpsDitta(fsInps)
{
	fsInps.addFoundSetFilterParam('idditta','=',_idDitta);
	return fsInps;
}

/**
 * Filtra le posizioni INAIL per il dipendente
 * 
 * @param {JSFoundset} fsInail
 *
 * @properties={typeid:24,uuid:"2FFA8BF5-3475-4226-8868-2C235545204C"}
 */
function filtraPosInailDitta(fsInail)
{
	fsInail.addFoundSetFilterParam('idditta','=',_idDitta);
	return fsInail;
}

/**
 * 
 * Filtra i contratti assegnabili al dipendente
 * 
 * @param {JSFoundset} fsCtr
 *
 * @properties={typeid:24,uuid:"443D66E6-B09A-4190-A57D-F1C54248BC04"}
 * @AllowToRunInFind
 */
function filtraContrattoDitta(fsCtr)
{
	/** @type {JSFoundSet<db:/ma_anagrafiche/ditte_contratti>}*/
	var fsCtrDitta = databaseManager.getFoundSet(globals.Server.MA_ANAGRAFICHE,globals.Table.DITTE_CONTRATTI); 
	fsCtrDitta.find();
	fsCtrDitta.idditta = _idDitta;
	fsCtrDitta.search();
	fsCtr.addFoundSetFilterParam('radicecontratto','IN',globals.foundsetToArray(fsCtrDitta,'codcontratto'));
	return fsCtr;
}

/**
 * Aggiorna la selezione della posizione INPS
 * 
 * @param {JSRecord} _rec
 *
 * @properties={typeid:24,uuid:"8CBCFBC5-D5C8-4F87-B5CF-E7438479435C"}
 */
function AggiornaSelezionePosInps(_rec)
{
	_idInpsDitta = _rec['iddittainps'];
	_codiceInpsDip = _rec['posizioneinps'];
	_descInpsDip = _rec['matricola'];
}

/**
 * Aggiorna la selezione della posizione INAIL
 * 
 * @param {JSRecord} _rec
 *
 * @properties={typeid:24,uuid:"ADE65BEE-B58E-4B1E-9635-5397A604E529"}
 */
function AggiornaSelezionePosInail(_rec)
{
	_idDittaInailPosizione = _rec['iddittainailposizione'];
	_codiceInailPosizione = _rec['posizioneinail'];
	_descInailPosizione = _rec['descrizione'];
}

/**
 * @param {JSRecord} _rec
 *
 * @properties={typeid:24,uuid:"5175F732-02D9-4A69-8FE1-D1B2D5CC3231"}
 */
function AggiornaSelezioneContratto(_rec)
{
	_idGrContr = _rec['idgruppocontrattuale'];
	_codGrContr = _rec['radicecontratto'];
	_descGrContr = _rec['descrizione'];
}

/**
 * @param {JSRecord} _rec
 *
 * @properties={typeid:24,uuid:"6A037D8B-59A4-425D-BF3B-617BF360D004"}
 */
function AggiornaSelezioneQualifica(_rec)
{
	_idQualifica = _rec['idtabqualifiche'];
	_codQualifica = _rec['radicequalifica'];
	_descQualifica = _rec['descrizione'];
}

/**
 * @param {JSRecord} _rec
 *
 * @properties={typeid:24,uuid:"5B4BCCF1-0607-4900-A16F-15733AC2C0CB"}
 * @AllowToRunInFind
 */
function AggiornaSelezioneRegola(_rec)
{
	_idRegola = _rec['idregole'];
	_codRegola = _rec['codiceregola'];
	_descRegola = _rec['descrizioneregola'];

	_valoreAgg = forms.agl_dd_dtl_l._valore = _rec['idregole'];

	var sqlRigaRegola = 'SELECT dbo.F_Regola_DefaultPartenza(?,?)';
	var arrRigaRegola = [_rec['idregole'], utils.dateFormat(_regolaDal, globals.ISO_DATEFORMAT)];
	var dsRigaRegola = databaseManager.getDataSetByQuery(globals.Server.MA_PRESENZE, sqlRigaRegola, arrRigaRegola, 1);
	var riga = dsRigaRegola.getValue(1, 1);

	//aggiorniamo automaticamente il giorno di partenza della regola
	var fsGiorno = databaseManager.getFoundSet(globals.Server.MA_PRESENZE, globals.Table.REGOLE_FASCE);
	if (fsGiorno.find())
	{
		fsGiorno['idregole'] = _rec['idregole'];
		fsGiorno['riga'] = riga;
		fsGiorno.search();
	}
	_valoreAgg = riga;
	_descRiga = fsGiorno['e2regolefasce_to_e2fo_fasceorarie']['descrizione'] ? fsGiorno['e2regolefasce_to_e2fo_fasceorarie']['descrizione'] : fsGiorno['e2regolefasce_to_e2fo_fasceorarie']['descrizautogenerata'];
}

/**
 * @param {JSRecord} _rec
 *
 * @properties={typeid:24,uuid:"F9C4C0F1-F096-4F55-8AF6-132C8C8437F2"}
 */
function AggiornaSelezioneRiga(_rec)
{
	_valoreAgg = _rec['riga'];
	_descRiga = _rec['e2regolefasce_to_e2fo_fasceorarie']['descrizione'] ?
    _rec['e2regolefasce_to_e2fo_fasceorarie']['descrizione'] :
	_rec['e2regolefasce_to_e2fo_fasceorarie']['descrizautogenerata'];
	
}

/**
 * TODO generated, please specify type and doc for the params
 * @param fsDitta
 *
 * @properties={typeid:24,uuid:"3A2A0831-6BAF-49A7-9DDC-E89F84A9A9BF"}
 */
function filtraDitta(fsDitta)
{
	fsDitta.addFoundSetFilterParam('tipologia','IN',[globals.Tipologia.STANDARD,globals.Tipologia.GESTITA_UTENTE]);
	return fsDitta;
}

/**
 * Filtra le sedi di lavoro della ditta selezionata
 * 
 * @param {JSFoundset} fsSdl
 *
 * @properties={typeid:24,uuid:"26C06F4B-61F9-4DA0-B1B6-F1C61E914204"}
 */
function filtraSediLavoroDitta(fsSdl)
{
	fsSdl.addFoundSetFilterParam('idditta','=',_idDitta);
	fsSdl.addFoundSetFilterParam('codtiposede','=',globals.TipiSedeLavoro.SEDE_OPERATIVA);
	return fsSdl;
}

/**
 * Filtra le regole selezionabili per la ditta indicata
 * 
 * @param {JSFoundset} fsRegola
 *
 * @properties={typeid:24,uuid:"450AB31E-9387-4F48-9DCC-AC1C3CCFCC71"}
 */
function filtraRegola(fsRegola)
{
	fsRegola.addFoundSetFilterParam('idditta','=', _idDitta);
	return fsRegola;
}

/**
 * Filtra i giorni di partenza selezionabili per la regola 
 * 
 * @param {JSFoundset} fsRiga
 *
 * @properties={typeid:24,uuid:"2BE63888-027B-4B9B-A5FF-9B06B813F65F"}
 */
function filtraRiga(fsRiga)
{
	fsRiga.addFoundSetFilterParam('idregole','=',_idRegola);
	return fsRiga;
}

/**
 * Aggiorna la selezione della sede di lavoro
 * 
 * @param {JSRecord} _rec
 *
 * @properties={typeid:24,uuid:"C16E7DCD-97B3-4634-B788-7098C5AA3F6C"}
 */
function AggiornaSelezioneSediLavoroDitta(_rec)
{
	_idDittaSede = _rec['iddittasede'];
	_codiceDittaSede = _rec['codice']
    _descDittaSede = _rec['descrizione'];
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"A96EA93E-A970-4E4E-B3A4-B1463C26D043"}
 */
function confermaNuovoDip(event)
{
	try
	{
		var autosave = databaseManager.getAutoSave();
		
		if(validaDatiDip())
		{			
			databaseManager.setAutoSave(false);
			databaseManager.startTransaction();
			
			/**
			 * Crea il lavoratore
			 */
			fs = fs || databaseManager.getFoundSet(globals.Server.MA_ANAGRAFICHE, globals.Table.LAVORATORI);
			
			/** @type {JSRecord<db:/ma_anagrafiche/lavoratori>} */
			var newLavoratore = fs.getRecord(fs.newRecord());
			if(!newLavoratore)
				throw new Error('Errore durante la creazione del lavoratore');
			
			newLavoratore.idditta 					= _idDitta;
			newLavoratore.iddittainps				= _idInpsDitta;
			newLavoratore.iddittainailposizione     = _idDittaInailPosizione;
			newLavoratore.codditta 					= _codiceDitta;
			newLavoratore.posizioneinps 			= _codiceInpsDip;
			
			newLavoratore.codice 					= _codiceDip;
			newLavoratore.codicefiscale             = _codiceFiscale;
			newLavoratore.iddittasede 				= _idDittaSede;
			newLavoratore.codcontratto 				= _codGrContr;
			newLavoratore.codtiporapporto           = _codTipoRapporto;
			newLavoratore.codqualifica 				= _codQualifica;
			newLavoratore.idlivello                 = _idLivello;
			newLavoratore.codcategoriaparticolare 	= '0';
			newLavoratore.codgestionepresenze 		= '0';
			newLavoratore.codtipopaga 				= _codTipoPaga ? _codTipoPaga : '0';
			newLavoratore.codturnista 				= _codTurnista ? _codTurnista : '0';			
			newLavoratore.percentualept 			= _percPartTime > 0 ? _percPartTime : 0;
			newLavoratore.percentualedisc 			= 0;
			newLavoratore.stagionale 				= 0;
			newLavoratore.utilizzamensa 			= _utilizzaMensa ? 1 : 0;
			newLavoratore.personaleviaggiante 		= 0;
			newLavoratore.areadirigenziale 			= 0;
			newLavoratore.facchino 					= 0;
			newLavoratore.provenienzaanag 			= 0;
			
			if(_dataAssunzione)
				newLavoratore.assunzione 			= _dataAssunzione;
			
			// verifica se esiste una persona gi√† associata al codice fiscale
			if(globals.getPersona(_codiceFiscale) == null)
			{
				/**
				 * Crea la persona 
				 */
				var newPersona = newLavoratore.lavoratori_to_persone.getRecord(newLavoratore.lavoratori_to_persone.newRecord());
				if(!newPersona)
			    	throw new Error('Errore durante la creazione della persona');
				
				newPersona.cognome 	  = _cognome ? _cognome : "";
				newPersona.nome 	  = _nome ? _nome : "";
				newPersona.sesso      = _sesso;
				newPersona.nominativo = newPersona.cognome + ' ' + newPersona.nome;
			}
			
			// crea recapito di base per email
			if(_email)
			{
				var newRecapitoMail = newPersona.persone_to_persone_recapiti.getRecord(newPersona.persone_to_persone_recapiti.newRecord());
				if(!newRecapitoMail)
					throw new Error('Errore durante la creazione del recapito standard (email)');
				
				newRecapitoMail.codtiporecapito = 'M'; // indirizzo mail
				newRecapitoMail.nprrecapito = 1;
				newRecapitoMail.datadecorrenza = null;
				newRecapitoMail.valore = _email;
				newRecapitoMail.manuale = 1;
			}
			
			// crea recapito telefono cellulare
			if(_cellulare)
			{
				var newRecapitoCell = newPersona.persone_to_persone_recapiti.getRecord(newPersona.persone_to_persone_recapiti.newRecord());
				if(!newRecapitoCell)
					throw new Error('Errore durante la creazione del recapito standard (cellulare)');
				
				newRecapitoMail.codtiporecapito = 'C'; // cellulare
				newRecapitoMail.nprrecapito = 1;
				newRecapitoMail.datadecorrenza = null;
				newRecapitoMail.valore = _cellulare;
				newRecapitoMail.manuale = 1;
			}
			
			// crea il dettaglio della classificazione principale
			if(_codRaggruppamentoDett)
			{
				var newLavoratoreClass = newLavoratore.lavoratori_to_lavoratori_classificazioni.getRecord(newLavoratore.lavoratori_to_lavoratori_classificazioni.newRecord());
				if(!newLavoratoreClass)
					throw new Error('Errore durante la creazione della classificazione');
				
				newLavoratoreClass.idditta = newLavoratore.idditta;
				newLavoratoreClass.codtipoclassificazione = _idDittaClassificazione;
				newLavoratoreClass.codclassificazione = _codRaggruppamentoDett;
			}
				
			 /**
    	     * Crea il lavoratore di job
    	     */
    	    /** JSRecord<db:/ma_anagrafiche/lavoratori_job> */
    	    var newLavoratoreJob = newLavoratore.lavoratori_to_lavoratori_job.getRecord(newLavoratore.lavoratori_to_lavoratori_job.newRecord());
    	    if(!newLavoratoreJob)
    	    	throw new Error('Errore durante la creazione del lavoratore job');
    	    
		    var sql = 'SELECT TOP 1 FinaleContratto FROM E2TabQualifiche WHERE RadiceQualifica = ?';
		    var arr = [_codQualifica];
		    var ds = databaseManager.getDataSetByQuery(globals.getSwitchedServer(globals.Server.MA_PRESENZE), sql, arr, -1);
		    var _finaleContratto = ds.getValue(1,1);
		    
		    newLavoratoreJob.codcontratto 		   = _codGrContr + '00' + _finaleContratto;
		    newLavoratoreJob.codlivello            = _codLivello;
		    newLavoratoreJob.qualificaassicurativa = 1;
		    
		    /**
		     * Crea i record necessari per la gestione dell'inquadramento
		     */
		    // CONTRATTO
		    var newContratto = newLavoratore.lavoratori_to_lavoratori_tipicampo.getRecord(newLavoratore.lavoratori_to_lavoratori_tipicampo.newRecord());
		    if(!newContratto)
		    	throw new Error('Errore durante la creazione del contratto');
		    
		    newContratto.codtipocampo = globals.TipiCampo.CONTRATTO;
		    newContratto.valore 	  = newLavoratoreJob.codcontratto;
		    newContratto.decorrenza   = newLavoratore.assunzione;		    
		    		    
		    /**
		     * Committa tutta la parte di anagrafica
		     */
		    var success = databaseManager.commitTransaction();
		    if(!success)
		    {
		 	   var failedRecords = databaseManager.getFailedRecords();
	 		   if (failedRecords && failedRecords.length > 0)
 				   throw new Error('Errore durante la creazione del lavoratore: ' + failedRecords[0].exception.getMessage());
		    }
		    
		    /**
		     * Eventuale gestione della parte di gestione esterna per ditte non gestite dallo studio
		     */
		    if(globals.getTipologiaDitta(_idDitta) == globals.Tipologia.GESTITA_UTENTE)
		    {
		    	/** type {JSFoundset <db:/ma_anagrafiche/lavoratori_gestioneesterna} */
		    	var fsLavoratoreGestEsterna = databaseManager.getFoundSet(globals.Server.MA_ANAGRAFICHE,'lavoratori_gestioneesterna');
		    	var newLavoratoreGestEsterna = fsLavoratoreGestEsterna.getRecord(fsLavoratoreGestEsterna.newRecord());
		    	if(!newLavoratoreGestEsterna)
		    		throw new Error('Errore durante la creazione della gestione esterna del lavoratore');
		    	newLavoratoreGestEsterna.idlavoratore = newLavoratore.idlavoratore;
		    	newLavoratoreGestEsterna.codlavoratoretracciato = null;
		    	newLavoratoreGestEsterna.escludi = null;
		    	
		    	/**
			     * Committa la parte relativa alle gestione esterna
			     */
			    var successGestEst = databaseManager.commitTransaction();
			    if(!successGestEst)
			    {
			 	   var failedRecordsGestEst = databaseManager.getFailedRecords();
		 		   if (failedRecordsGestEst && failedRecordsGestEst.length > 0)
	 				   throw new Error('Errore durante la creazione della gestione esterna del lavoratore: ' + failedRecordsGestEst[0].exception.getMessage());
			    }
		    }
		    
		    /**
		     * Crea il record per la decorrenza della regola
		     */
		    if(_idRegola != null)
		    {
		    	/** @type {JSFoundSet<db:/ma_presenze/e2dcg_decorrenza>}*/
		    	var fsDecRegola = databaseManager.getFoundSet(globals.Server.MA_PRESENZE,globals.Table.LAVORATORI_DECORRENZE)
		    	var newRegola = fsDecRegola.getRecord(fsDecRegola.newRecord());
		        if(!newRegola)
		        	throw new Error('Errore durante la creazione della decorrenza regola');
		        newRegola.iddcg_campi = 3;
		        newRegola.id_legato = newLavoratore.idlavoratore_string;
		        newRegola.decorrenza = _regolaDal;
		        newRegola.valore = _idRegola;
		        newRegola.stato = 0;
		        newRegola.valoreagg = _valoreAgg;
		        newRegola.richiestoil = globals.TODAY;
		        newRegola.richiestoda = _to_sec_user$user_id.user_name;
		    }
		    
		    /**
		     * Crea il record per la decorrenza del badge
		     */
		    if(_badge != null)
		    {
		    	/** @type {JSFoundSet<db:/ma_presenze/e2dcg_decorrenza>}*/
		    	var fsDecBadge = databaseManager.getFoundSet(globals.Server.MA_PRESENZE,globals.Table.LAVORATORI_DECORRENZE)
		    	var newBadge = fsDecBadge.getRecord(fsDecBadge.newRecord());
		        if(!newBadge)
		        	throw new Error('Errore durante la creazione della decorrenza badge');
		        newBadge.id_legato = newLavoratore.idlavoratore_string;
		        newBadge.iddcg_campi = 2;
		        newBadge.decorrenza = _badgeDal;
		        newBadge.valore = _badge;
		        newBadge.stato = 0;
		        newBadge.richiestoil = globals.TODAY;
		        newBadge.richiestoda = _to_sec_user$user_id.user_name;
		    }
		    
		    /**
		     * Committa la parte relativa alle decorrenze
		     */
		    var successDec = databaseManager.commitTransaction();
		    if(!successDec)
		    {
		 	   var failedRecordsDec = databaseManager.getFailedRecords();
	 		   if (failedRecordsDec && failedRecordsDec.length > 0)
 				   throw new Error('Errore durante la creazione delle decorrenze del lavoratore: ' + failedRecordsDec[0].exception.getMessage());
		    }
			
		    databaseManager.refreshRecordFromDatabase(fs,-1);
		    globals.lookupFoundset(newLavoratore.idlavoratore,forms.agl_header_dtl.foundset);
		    globals.ma_utl_setStatus(globals.Status.BROWSE,controller.getName());
	    	globals.svy_mod_closeForm(event);
		}
//		else 
//			setStatusWarning('Controllare i dati inseriti!');
//			globals.ma_utl_showWarningDialog('Controllare i dati inseriti','Inserisci lavoratore esterno');
	}
	catch(ex)
	{
		application.output(ex.message, LOGGINGLEVEL.ERROR);
		databaseManager.rollbackTransaction();
		
		setStatusError(ex.message);
//		globals.ma_utl_showErrorDialog('Inserimento non riuscito. Contattare lo studio');
	}
	finally
	{
		databaseManager.setAutoSave(autosave);
	}
}

/**
 * @properties={typeid:24,uuid:"0EBEE4ED-B9D2-40F2-BC46-E78D81277151"}
 */
function validaDatiDip()
{
	if(!_idDitta || !_idDittaSede)
	{
		setStatusWarning('Inserire la ditta di appartenenza del lavoratore');
	    return false;
	}
	if(!_idDittaSede)
	{
		setStatusWarning('Inserire la sede di lavoro per il nuovo lavoratore');
	    return false;
	}
	if(!_codiceDip || _codiceDip <= 0)
	{
		setStatusWarning('Inserire il codice del nuovo lavoratore');
	    return false;
	}
	if(_dataAssunzione == null)
	{
		setStatusWarning('Inserire la data di assunzione del nuovo lavoratore');
	    return false;
	}
	if(!_codiceFiscale)
	{
		setStatusWarning('Inserire il codice fiscale del nuovo lavoratore');
	    return false;
	}
	if(!_idInpsDitta)
	{
		setStatusWarning('Inserire la sede INPS del nuovo lavoratore');
	    return false;
	}
	if(!_idDittaInailPosizione)
	{
		setStatusWarning('Inserire la posizione INAIL del nuovo lavoratore');
	    return false;
	}
	if(!_codGrContr)
	{
		setStatusWarning('Inserire il codice contrattuale del nuovo lavoratore');
	    return false;
	}
	if(!_codTipoRapporto)
	{
		setStatusWarning('Inserire il tipo di rapporto (tempo det./indet. del nuovo lavoratore');
	    return false;
	}
	if(!_codQualifica)
	{
		setStatusWarning('Inserire la qualifica del nuovo lavoratore');
        return false;
	}
	
	return true;
}

/** *
 * @param _firstShow
 * @param _event
 *
 * @properties={typeid:24,uuid:"799870A7-789F-4793-80E6-1760ABFD9907"}
 */
function onShowForm(_firstShow, _event) {
	
    _super.onShowForm(_firstShow, _event);
    
    plugins.busy.prepare();
    
    resetValues();
    
    settaCodiceDipendente();
    AggiornaClassificazioni();
    
    var isInterinale = globals.isInterinale(_idDitta);
    elements.fld_badge.visible = elements.fld_badge_dal.visible = (_idDitta != null && globals.haOrologio(isInterinale ? globals.getDittaRiferimento(_idDitta) : _idDitta));
    
    globals.ma_utl_setStatus(globals.Status.EDIT,controller.getName());
}

/**
 * Perform the element default action.
 *
 * @param {JSEvent} event the event that triggered the action
 *
 * @private
 *
 * @properties={typeid:24,uuid:"434BB89D-16D4-4E4B-85D4-30580A2A7D6B"}
 */
function annullaInserimentoDip(event) {
	
	globals.ma_utl_setStatus(globals.Status.BROWSE,controller.getName());
	globals.svy_mod_closeForm(event);
}

/**
 * @properties={typeid:24,uuid:"65F71426-E82F-4CD1-9BB5-591A3F68797D"}
 */
function resetValues() 
{
	_idDittaLegata = _idDitta ? globals.getDittaRiferimento(_idDitta) : null;
	_codiceDip = null;
	_idDittaSede = null;
	_codiceDittaSede = null;
	_descDittaSede = null;
	_codiceInpsDip = null;
	_descInpsDip = null;
	_idInpsDitta = null;
	_idDittaInailPosizione = null;
	_codiceInailPosizione = null;
	_descInailPosizione = null;
	_idGrContr = null;
	_codGrContr = null;
	_descGrContr = null;
	_idQualifica = null;
	_codQualifica = null;
	_descQualifica = null;
	_percPartTime = null;
	_utilizzaMensa = false;
	_cognome = null;
	_nome = null;
	_codiceFiscale = null;
	_dataAssunzione = null;
	_sesso = null;
    _idLivello = null;
    _codLivello = null;
    _codTipoPaga = null;
    _codTipoRapporto = null;
    _codTurnista = null;
    _regolaDal = null;
    _codRegola = null;
    _descRegola = null;
    _valoreAgg = null;
    _descRiga = null;
    _idRegola = null;
    _badgeDal = null;
    _badge = null;
}

/**
 *
 * @param {JSEvent} event
 *
 * @properties={typeid:24,uuid:"24A7EAEB-CBA9-4410-B2ED-0313363FCC6D"}
 */
function onHide(event) {
	annullaInserimentoDip(event);
}

/**
 * Handle changed data.
 *
 * @param {Date} oldValue old value
 * @param {Date} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @returns {Boolean}
 *
 * @private
 *
 * @properties={typeid:24,uuid:"D62E0452-C890-495A-9085-7297EA5CE988"}
 */
function onDataChangeAssunzione(oldValue, newValue, event) 
{
	_regolaDal = newValue;
	_badgeDal = newValue;
	return true;
}

/**
 * Handle changed data, return false if the value should not be accepted. In NGClient you can return also a (i18n) string, instead of false, which will be shown as a tooltip.
 *
 * @param {String} oldValue old value
 * @param {String} newValue new value
 * @param {JSEvent} event the event that triggered the action
 *
 * @return {Boolean}
 *
 * @private
 *
 * @properties={typeid:24,uuid:"4494ED59-1CF2-46C6-8330-7FC560093AA9"}
 */
function onDataChangeRaggruppamento(oldValue, newValue, event) 
{
	_codRaggruppamentoDett = null;
	_descRaggruppamentoDett = '';
	
	var split = newValue.split(" ");
    _codRaggruppamento = split[0];
	_idDittaClassificazione = split[1];
	
	return true;
}

/**
 * @param {JSFoundSet<db:/ma_anagrafiche/ditte_classificazioni>} fsClassifDett
 *
 * @properties={typeid:24,uuid:"AA4D109A-65B7-4ADE-860D-ECFDB97BC9E0"}
 */
function filterRaggruppamentoDettaglio(fsClassifDett)
{
	fsClassifDett.addFoundSetFilterParam('iddittaclassificazione'
					                      ,'IN'
										  ,_codRaggruppamento);
	return fsClassifDett;
}

/**
 * @param {JSRecord<db:/ma_anagrafiche/ditte_classificazionidettaglio>} rec
 *
 * @properties={typeid:24,uuid:"15B815F9-4DA5-4BCF-8C0D-552CF16D0333"}
 */
function updateRaggruppamentoDettaglio(rec)
{
	_codRaggruppamentoDett = rec.codice;
	_descRaggruppamentoDett = rec.descrizione;
}